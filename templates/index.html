{% extends "layout.html" %}

{% block title %}Dashboard - Livro Caixa{% endblock %}

{% block content %}
<header class="mb-8">
    <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100">Dashboard Financeiro</h1>
    <p class="text-gray-700 dark:text-gray-300">A sua visão geral financeira.</p>
</header>

<section id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
    <div class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-semibold text-gray-600 dark:text-gray-300 mb-2">Saldo Atual</h2>
        <p class="text-3xl font-bold {{ 'text-green-600 dark:text-green-400' if balance >= 0 else 'text-red-600 dark:text-red-400' }}">R$ {{ "%.2f"|format(balance) }}</p>
    </div>
    <div class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-semibold text-gray-600 dark:text-gray-300 mb-2">Contas a Receber</h2>
        <p class="text-3xl font-bold text-yellow-600 dark:text-yellow-400">R$ {{ "%.2f"|format(total_pending_income) }}</p>
    </div>
    <div class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-semibold text-gray-600 dark:text-gray-300 mb-2">Contas a Pagar</h2>
        <p class="text-3xl font-bold text-orange-600 dark:text-orange-400">R$ {{ "%.2f"|format(total_pending_expense) }}</p>
    </div>
    <div class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-semibold text-gray-600 dark:text-gray-300 mb-2">Total Recebido</h2>
        <p class="text-3xl font-bold text-blue-600 dark:text-blue-400">R$ {{ "%.2f"|format(total_income) }}</p>
    </div>
    <div class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-semibold text-gray-600 dark:text-gray-300 mb-2">Total Pago</h2>
        <p class="text-3xl font-bold text-red-600 dark:text-red-400">R$ {{ "%.2f"|format(total_expense) }}</p>
    </div>
</section>

<section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <div class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 flex flex-col">
        <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Despesas por Categoria</h3>
        <div class="relative h-80">
            <canvas id="expensesPieChart"></canvas>
        </div>
    </div>
    <div class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm p-6 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 flex flex-col">
        <div class="flex justify-between items-center mb-4">
             <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">Fluxo de Caixa (Últimos 6 Meses)</h3>
        </div>
        <div class="relative h-80">
            <canvas id="cashFlowLineChart"></canvas>
        </div>
    </div>
</section>
{% endblock %}

{% block page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Configuração Global do Chart.js para o tema escuro ---
        const isDarkMode = document.documentElement.classList.contains('dark');
        Chart.defaults.color = isDarkMode ? '#e5e7eb' : '#374151';
        Chart.defaults.borderColor = isDarkMode ? '#4b5563' : '#d1d5db';

        // --- Gráfico de Pizza (Despesas) ---
        const pieChartData = {{ pie_chart_data|tojson|safe }};
        const pieCtx = document.getElementById('expensesPieChart').getContext('2d');
        if (pieChartData.data.length > 0) {
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: pieChartData.labels,
                    datasets: [{
                        label: 'Despesas por Categoria',
                        data: pieChartData.data,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: isDarkMode ? '#f3f4f6' : '#1f2937' } }
                    }
                }
            });
        } else {
            pieCtx.font = "16px Inter";
            pieCtx.fillStyle = isDarkMode ? '#f3f4f6' : '#1f2937';
            pieCtx.textAlign = "center";
            pieCtx.fillText("Sem dados de despesas para exibir.", pieCtx.canvas.width / 2, pieCtx.canvas.height / 2);
        }

        // --- Gráfico de Linha Animado (Fluxo de Caixa) ---
        const lineCtx = document.getElementById('cashFlowLineChart').getContext('2d');
        const fullLineChartData = {{ line_chart_data|tojson|safe }};

        if (fullLineChartData.data.length > 0) {
            const lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Saldo Mensal (Receitas - Despesas)',
                        data: [],
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 400 // Animação suave ao adicionar pontos
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: isDarkMode ? '#f3f4f6' : '#1f2937' }, grid: { color: isDarkMode ? '#4b5563' : '#e5e7eb' } },
                        x: { ticks: { color: isDarkMode ? '#f3f4f6' : '#1f2937' }, grid: { color: isDarkMode ? '#4b5563' : '#e5e7eb' } }
                    },
                    plugins: { legend: { labels: { color: isDarkMode ? '#f3f4f6' : '#1f2937' } } }
                }
            });

            function runAnimation() {
                let monthIndex = 0;
                const totalMonths = fullLineChartData.labels.length;

                // Limpa o gráfico antes de começar
                lineChart.data.labels = [];
                lineChart.data.datasets[0].data = [];
                lineChart.update('none'); // Atualiza sem animação para limpar

                function addNextMonth() {
                    if (monthIndex < totalMonths) {
                        lineChart.data.labels.push(fullLineChartData.labels[monthIndex]);
                        lineChart.data.datasets[0].data.push(fullLineChartData.data[monthIndex]);
                        lineChart.update();
                        monthIndex++;
                    }
                }
                // Define um intervalo para adicionar cada mês
                const intervalId = setInterval(addNextMonth, 600);

                // Para o intervalo quando todos os meses forem adicionados
                setTimeout(() => clearInterval(intervalId), totalMonths * 600);
            }

            // Inicia a animação ao carregar e repete a cada 15 segundos
            runAnimation();
            setInterval(runAnimation, 15000 + (fullLineChartData.labels.length * 600)); // 15 segundos + tempo da animação

        } else {
            lineCtx.font = "16px Inter";
            lineCtx.fillStyle = isDarkMode ? '#f3f4f6' : '#1f2937';
            lineCtx.textAlign = "center";
            lineCtx.fillText("Sem dados de fluxo de caixa para exibir.", lineCtx.canvas.width / 2, lineCtx.canvas.height / 2);
        }
    });
</script>
{% endblock %}